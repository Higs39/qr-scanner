<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Production QR Station</title>
  <!-- Try to load QR library directly first -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js" 
          crossorigin="anonymous"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin:0; background:#f4f6f8; }
    .page { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .top-bar {
      display:flex; flex-wrap:wrap; gap:8px;
      justify-content:space-between; align-items:center;
      margin-bottom:12px;
    }
    .pill {
      padding:6px 10px; border-radius:999px;
      background:#e1e5ec; font-size:13px;
    }
    .pill strong { font-weight:600; }
    .controls-row { display:flex; flex-wrap:wrap; gap:8px; margin: 8px 0 12px; }
    button, select {
      padding:8px 10px; border-radius:6px;
      border:1px solid #c0c6d0; background:white;
      font-size:14px; cursor:pointer;
    }
    button.primary { background:#2257d8; color:white; border-color:#2257d8; }
    button.small { padding:4px 8px; font-size:12px; }
    #reader { width:100%; max-width:520px; margin: 0 auto 12px; background:#000; position:relative; border-radius:8px; overflow:hidden; }
    #reader.duplicate-warning {
      box-shadow: 0 0 0 4px #ff4444, 0 0 20px rgba(255,68,68,0.6);
      animation: pulse-red 0.5s ease-in-out;
    }
    @keyframes pulse-red {
      0%, 100% { box-shadow: 0 0 0 4px #ff4444, 0 0 20px rgba(255,68,68,0.6); }
      50% { box-shadow: 0 0 0 8px #ff4444, 0 0 40px rgba(255,68,68,0.8); }
    }
    .duplicate-overlay {
      position:absolute; top:0; left:0; right:0; bottom:0;
      background:rgba(255,68,68,0.3); z-index:10;
      display:none; align-items:center; justify-content:center;
      pointer-events:none;
    }
    .duplicate-overlay.show {
      display:flex; animation: flash-red 1s ease-out;
    }
    @keyframes flash-red {
      0% { background:rgba(255,68,68,0.1); }
      50% { background:rgba(255,68,68,0.5); }
      100% { background:rgba(255,68,68,0.3); }
    }
    .duplicate-text {
      background:rgba(255,68,68,0.95); color:white;
      padding:12px 20px; border-radius:8px;
      font-weight:600; font-size:16px;
      box-shadow:0 4px 12px rgba(0,0,0,0.3);
    }
    .panel {
      background:white; border-radius:10px; padding:12px;
      margin-bottom:12px; box-shadow:0 2px 4px rgba(0,0,0,0.05);
    }
    .panel h3 { margin:0 0 8px; font-size:16px; }
    .field-row {
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:center; margin-bottom:8px; font-size:14px;
    }
    .field-row label { font-size:13px; color:#444; }
    .tag {
      display:inline-block; padding:3px 7px;
      border-radius:999px; font-size:11px;
      background:#eef1f7; margin-right:6px;
    }
    .tag.new { background:#e0ffe5; }
    .tag.update { background:#ffeccc; }
    .log-area {
      white-space:pre-wrap; font-size:12px;
      background:#f1f3f7; padding:6px 8px;
      border-radius:6px; margin-top:4px;
    }
    table {
      border-collapse:collapse; width:100%; font-size:12px;
    }
    th, td { border:1px solid #d2d5dd; padding:4px 6px; }
    th { background:#eef1f7; text-align:left; font-weight:600; }

    /* modal */
    .modal-backdrop {
      position:fixed; inset:0; background:rgba(0,0,0,0.5);
      display:none; align-items:center; justify-content:center; z-index:9999;
    }
    .modal {
      background:#fff; width:min(92vw, 380px);
      border-radius:10px; padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,0.25);
    }
    .modal input {
      width:100%; padding:7px 8px;
      border-radius:6px; border:1px solid #c0c6d0;
    }
  </style>
</head>
<body>
<div class="page">

  <div class="top-bar">
    <div style="display:flex;flex-wrap:wrap;gap:6px;">
      <div class="pill">Scanner: <strong id="scannerDisplay">unset</strong></div>
      <div class="pill">Station: <strong id="stationDisplay">unset</strong></div>
    </div>
    <div class="controls-row" style="margin:0;">
      <button id="btnChangeIds" class="small">Change IDs</button>
      <button id="btnExportCsv" class="small">Export CSV</button>
      <button id="btnClearScans" class="small">Clear scans</button>
    </div>
  </div>

  <!-- SCANNER PANEL -->
  <div class="panel">
    <div class="controls-row">
      <button id="btnStart" class="primary" disabled>Start camera</button>
      <button id="btnStop" disabled>Stop camera</button>
    </div>
    <div id="reader">
      <div class="duplicate-overlay" id="duplicateOverlay">
        <div class="duplicate-text">⚠ DUPLICATE SCAN ⚠</div>
      </div>
    </div>
    <div id="scanLog" class="log-area">Loading QR library…</div>
  </div>

  <!-- CONTEXT PANEL -->
  <div class="panel">
    <h3>Context</h3>
    <div class="field-row">
      <label>Stage:</label>
      <select id="stageSelect">
        <option value="receiving">Receiving</option>
        <option value="cutting">Cutting</option>
        <option value="edging">Edging</option>
        <option value="packing">Packing</option>
        <option value="shipment">Shipment</option>
        <option value="install">Install</option>
      </select>

      <label>Entity:</label>
      <select id="entitySelect">
        <option value="cabinet">Cabinet</option>
        <option value="pallet">Pallet</option>
        <option value="room">Room</option>
        <option value="accessory">Accessory</option>
        <option value="trolley">Trolley</option>
      </select>
    </div>
  </div>

  <!-- LAST SCAN -->
  <div class="panel">
    <h3>Last scan</h3>
    <div id="lastScanContent">No scan yet.</div>
  </div>

  <!-- HISTORY -->
  <div class="panel">
    <h3>History</h3>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>UID</th>
          <th>Stage</th>
          <th>Entity</th>
          <th>Scanner</th>
          <th>Station</th>
          <th>Timestamp</th>
        </tr>
      </thead>
      <tbody id="historyBody"></tbody>
    </table>
  </div>

</div>

<!-- DEVICE ID MODAL -->
<div id="deviceModalBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Set device identity</h3>
    <p style="font-size:13px;margin:4px 0 10px;">Saved once & used for every scan.</p>

    <label>Scanner ID</label>
    <input id="deviceScannerInput" placeholder="PH-01">

    <label style="margin-top:10px;">Station ID</label>
    <input id="deviceStationInput" placeholder="ST-01">

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
      <button id="deviceModalCancel" class="small">Cancel</button>
      <button id="deviceModalSave" class="small primary">Save</button>
    </div>
  </div>
</div>

<script>
/* ===========
   LOAD QR LIB
   =========== */
const CDN_SOURCES = [
  "https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js",
  "https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js",
  "https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/minified/html5-qrcode.min.js",
  "https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"
];

function loadScript(src){
  return new Promise((resolve,reject)=>{
    console.log("Attempting to load from:", src);
    
    // Use simple script tag method which is more reliable
    const s=document.createElement("script");
    s.src=src;
    s.type="text/javascript";
    s.async=false; // Load synchronously to avoid race conditions
    s.crossOrigin="anonymous";
    
    let resolved = false;
    
    s.onload=()=>{
      if(resolved) return;
      // Give the library a moment to initialize
      let attempts = 0;
      const checkLib = setInterval(() => {
        if(window.Html5Qrcode) {
          resolved = true;
          clearInterval(checkLib);
          console.log("✓ Library loaded successfully from", src);
          resolve(src);
        } else if(attempts++ > 200) {
          clearInterval(checkLib);
          if(!resolved) {
            resolved = true;
            reject(new Error("Library not available after load"));
          }
        }
      }, 50);
    };
    
    s.onerror=(e)=>{
      if(resolved) return;
      resolved = true;
      console.error("✗ Failed to load script from", src);
      reject(new Error("Script load failed"));
    };
    
    // Set timeout as fallback
    setTimeout(() => {
      if(!resolved && window.Html5Qrcode) {
        resolved = true;
        console.log("✓ Library available after timeout from", src);
        resolve(src);
      } else if(!resolved) {
        resolved = true;
        reject(new Error("Timeout waiting for library"));
      }
    }, 15000);
    
    document.head.appendChild(s);
  });
}

// Wait for DOM and library to be ready
async function initLibrary() {
  const scanLogEl = document.getElementById("scanLog");
  if(!scanLogEl) {
    console.error("scanLog element not found");
    return;
  }
  
  // First check if library is already loaded from the direct script tag
  let attempts = 0;
  const checkDirectLoad = setInterval(() => {
    if(window.Html5Qrcode){
      clearInterval(checkDirectLoad);
      scanLogEl.textContent = "✓ QR library loaded successfully.";
      const btnStart = document.getElementById("btnStart");
      if(btnStart) btnStart.disabled = false;
      initializeApp();
      return;
    }
    attempts++;
    if(attempts > 30) { // Wait up to 3 seconds for direct load
      clearInterval(checkDirectLoad);
      // If not loaded yet, try dynamic loading
      loadLibraryDynamically();
    }
  }, 100);
  
  // Also try dynamic loading if direct load doesn't work
  async function loadLibraryDynamically(){
    scanLogEl.textContent = "Loading QR library...";
    
    for(let i = 0; i < CDN_SOURCES.length; i++){
      const src = CDN_SOURCES[i];
      try{
        console.log(`[${i+1}/${CDN_SOURCES.length}] Trying to load from:`, src);
        scanLogEl.textContent = `Loading QR library (${i+1}/${CDN_SOURCES.length})...`;
        
        await loadScript(src);
        
        // Double check library is available
        if(window.Html5Qrcode){
          scanLogEl.textContent = "✓ QR library loaded successfully.";
          const btnStart = document.getElementById("btnStart");
          if(btnStart) btnStart.disabled = false;
          initializeApp();
          return;
        } else {
          console.warn("Script loaded but Html5Qrcode not found");
        }
      }catch(e){
        console.error(`[${i+1}/${CDN_SOURCES.length}] Failed to load from`, src, e);
        // Continue to next source
      }
    }
    
    // All sources failed - show helpful error
    scanLogEl.textContent = "✗ Failed to load QR library. Please check:\n1. Internet connection\n2. Browser console for details\n3. Try refreshing the page";
    console.error("All CDN sources failed. Current sources tried:", CDN_SOURCES);
  }
}

// Check if DOM is already loaded
if(document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initLibrary);
} else {
  // DOM already loaded, run immediately
  initLibrary();
}

function initializeApp() {
/* ===========
   STORAGE HELPERS
   =========== */
const STORE_KEY = "qr_scans_simple";
const IDS_KEY   = "device_ids_simple";

function loadStore(){ return JSON.parse(localStorage.getItem(STORE_KEY)||"{}"); }
function saveStore(db){ localStorage.setItem(STORE_KEY, JSON.stringify(db)); }

function loadIds(){ return JSON.parse(localStorage.getItem(IDS_KEY)||"{}"); }
function saveIds(ids){ localStorage.setItem(IDS_KEY, JSON.stringify(ids)); }

/* ===========
   UI ELEMENTS
   =========== */
const btnStart    = document.getElementById("btnStart");
const btnStop     = document.getElementById("btnStop");
const btnClear    = document.getElementById("btnClearScans");
const btnExport   = document.getElementById("btnExportCsv");
const btnChangeIds= document.getElementById("btnChangeIds");
const scanLog     = document.getElementById("scanLog");
const readerDiv = document.getElementById("reader");
const duplicateOverlay = document.getElementById("duplicateOverlay");

const stageSelect = document.getElementById("stageSelect");
const entitySelect = document.getElementById("entitySelect");

const lastScanContent = document.getElementById("lastScanContent");
const historyBody = document.getElementById("historyBody");

const scannerDisplay = document.getElementById("scannerDisplay");
const stationDisplay = document.getElementById("stationDisplay");

// Verify essential elements exist
if(!btnStart || !btnStop || !scanLog || !readerDiv){
  console.error("Required elements not found!", {btnStart, btnStop, scanLog, readerDiv});
  if(scanLog) scanLog.textContent = "Error: Page elements missing.";
  return;
}

const modal = document.getElementById("deviceModalBackdrop");
const mScanner = document.getElementById("deviceScannerInput");
const mStation = document.getElementById("deviceStationInput");
const mCancel  = document.getElementById("deviceModalCancel");
const mSave    = document.getElementById("deviceModalSave");

/* ===========
   INIT IDs
   =========== */
function updateIdDisplay(){
  const ids = loadIds();
  scannerDisplay.textContent = ids.scanner_id || "unset";
  stationDisplay.textContent = ids.station_id || "unset";
}
updateIdDisplay();

/* ===========
   SHOW / HIDE MODAL
   =========== */
function openModal(){
  const ids = loadIds();
  mScanner.value = ids.scanner_id || "";
  mStation.value = ids.station_id || "";
  modal.style.display="flex";
}
function closeModal(){
  modal.style.display="none";
}

btnChangeIds.onclick = openModal;
mCancel.onclick = closeModal;

mSave.onclick = () => {
  const scanner_id = mScanner.value.trim();
  const station_id = mStation.value.trim();
  if(!scanner_id || !station_id){
    alert("Both values required.");
    return;
  }
  saveIds({scanner_id, station_id});
  updateIdDisplay();
  closeModal();
  
  // Process pending scan if any
  if(pendingParsed){
    // Auto-set entity from parsed data if available
    if(pendingParsed.entityFromQR && entitySelect){
      const options = Array.from(entitySelect.options);
      const matchingOption = options.find(opt => opt.value === pendingParsed.entityFromQR);
      if(matchingOption){
        entitySelect.value = pendingParsed.entityFromQR;
      }
    }
    processScan(pendingParsed);
    pendingPayload = null;
    pendingParsed = null;
  } else if(pendingPayload){
    // Fallback: if we only have raw payload, parse it now
    const parsed = parseQrPayload(pendingPayload);
    if(parsed.entityFromQR && entitySelect){
      const options = Array.from(entitySelect.options);
      const matchingOption = options.find(opt => opt.value === parsed.entityFromQR);
      if(matchingOption){
        entitySelect.value = parsed.entityFromQR;
      }
    }
    processScan(parsed);
    pendingPayload = null;
  }
};

/* ===========
   HISTORY RENDER
   =========== */
function renderHistory(){
  const db = loadStore();
  const rows = Object.keys(db).sort();
  historyBody.innerHTML = "";

  rows.forEach((uid,i)=>{
    const r = db[uid];
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${uid}</td>
      <td>${r.stage || ""}</td>
      <td>${r.entity || ""}</td>
      <td>${r.scanner_id || ""}</td>
      <td>${r.station_id || ""}</td>
      <td>${r.timestamp || ""}</td>
    `;
    historyBody.appendChild(tr);
  });
}
renderHistory();

/* ===========
   QR PAYLOAD PARSER
   =========== */
function parseQrPayload(rawText){
  const trimmed = rawText.trim();
  
  // Try to parse as JSON
  try {
    const parsed = JSON.parse(trimmed);
    if(parsed && typeof parsed === 'object'){
      // Extract fields from JSON
      const uid = parsed.product_id || trimmed;
      return {
        uid,
        product_id: parsed.product_id || uid,
        product_type: parsed.product_type,
        variant_info: parsed.variant_info,
        entityFromQR: parsed.entity,
        order_id: parsed.order_id
      };
    }
  } catch(e) {
    // Not valid JSON, treat as plain text
  }
  
  // Plain text fallback
  return {
    uid: trimmed,
    product_id: trimmed,
    product_type: undefined,
    variant_info: undefined,
    entityFromQR: undefined,
    order_id: undefined
  };
}

/* ===========
   QR SCANNER
   =========== */
let qr = null;
let running = false;
let debounceUntil = 0;
let pendingPayload = null;
let pendingParsed = null;

btnStart.onclick = async () => {
  console.log("Start button clicked!");
  try{
    scanLog.textContent="Checking library...";
    if(!window.Html5Qrcode){ 
      scanLog.textContent="Library missing. Please refresh the page.";
      console.error("Html5Qrcode not found");
      return; 
    }
    if(running) {
      scanLog.textContent="Camera already running.";
      return;
    }

    scanLog.textContent="Requesting camera access...";
    qr = new Html5Qrcode("reader");
    console.log("Html5Qrcode instance created");
    
    // Request camera permission first
    let cams = [];
    try {
      cams = await Html5Qrcode.getCameras();
    } catch(e) {
      console.log("getCameras failed, requesting permission directly:", e);
      // If getCameras fails, try requesting permission directly
      try {
        if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
          scanLog.textContent="Camera API not available. Use HTTPS or localhost.";
          return;
        }
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        stream.getTracks().forEach(track => track.stop());
        cams = await Html5Qrcode.getCameras();
      } catch(permError) {
        console.error("Permission error:", permError);
        scanLog.textContent="Camera permission denied. Please allow camera access and try again.";
        return;
      }
    }
    
    if(!cams || !cams.length){
      scanLog.textContent="No camera found. Please connect a camera.";
      return;
    }

    const cam = cams.find(c=>/back|rear/i.test(c.label)) || cams[0];
    scanLog.textContent=`Starting camera: ${cam.label || cam.id}...`;

    // Simplified config - qrbox can be a number (width) or object
    await qr.start(
      cam.id, 
      {
        fps: 10,
        qrbox: 320
      }, 
      onDecoded,
      undefined
    );
    
    running = true;
    btnStart.disabled=true;
    btnStop.disabled=false;
    scanLog.textContent="Camera started. Point at QR code.";
  }catch(e){
    console.error("Camera error:", e);
    scanLog.textContent="Error: " + (e.message || String(e));
    running = false;
    btnStart.disabled=false;
    btnStop.disabled=true;
    if(qr){
      try{ await qr.stop(); }catch(ex){}
      try{ await qr.clear(); }catch(ex){}
    }
  }
};

btnStop.onclick = async () => {
  if(!running || !qr) return;
  try{ 
    await qr.stop(); 
    await qr.clear();
  }catch(e){
    console.error("Stop error:", e);
  }
  running=false;
  btnStart.disabled=false;
  btnStop.disabled=true;
  scanLog.textContent="Camera stopped.";
  
  // Clear any duplicate warning
  if(readerDiv) readerDiv.classList.remove("duplicate-warning");
  if(duplicateOverlay) duplicateOverlay.classList.remove("show");
};

function onDecoded(text){
  const now=Date.now();
  if(now<debounceUntil) return;
  debounceUntil = now + 1200;

  // Parse QR payload
  const parsed = parseQrPayload(text);
  const ids = loadIds();

  // Auto-set entity dropdown if entityFromQR matches an option
  if(parsed.entityFromQR && entitySelect){
    const options = Array.from(entitySelect.options);
    const matchingOption = options.find(opt => opt.value === parsed.entityFromQR);
    if(matchingOption){
      entitySelect.value = parsed.entityFromQR;
    }
  }

  if(!ids.scanner_id || !ids.station_id){
    pendingPayload = text.trim();
    pendingParsed = parsed;
    openModal();
    scanLog.textContent="Please set Scanner ID and Station ID first.";
    return;
  }

  processScan(parsed);
}

function showDuplicateWarning(){
  if(!readerDiv) return;
  
  // Add red border class
  readerDiv.classList.add("duplicate-warning");
  
  // Show overlay if it exists
  if(duplicateOverlay){
    duplicateOverlay.classList.add("show");
  }
  
  // Clear after 2 seconds
  setTimeout(() => {
    readerDiv.classList.remove("duplicate-warning");
    if(duplicateOverlay){
      duplicateOverlay.classList.remove("show");
    }
  }, 2000);
}

function processScan(parsed){
  const ids = loadIds();
  const db = loadStore();

  const timestamp = new Date().toISOString();
  const stage = stageSelect.value;
  const entity = entitySelect ? entitySelect.value : undefined;
  const uid = parsed.uid;
  const product_id = parsed.product_id || uid;

  let status = "update";
  const isDuplicate = !!db[uid];
  if(!isDuplicate){
    status = "new";
  }

  // Store record with product metadata
  db[uid] = {
    scanner_id: ids.scanner_id,
    station_id: ids.station_id,
    stage,
    entity,
    timestamp,
    product_id: product_id,
    product_type: parsed.product_type,
    variant_info: parsed.variant_info,
    order_id: parsed.order_id
  };

  saveStore(db);
  renderHistory();

  // Build Last Scan panel HTML
  let html = `<div><strong>UID:</strong> ${uid}</div>`;
  
  // Show product_id if different from UID
  if(product_id && product_id !== uid){
    html += `<div><strong>Product ID:</strong> ${product_id}</div>`;
  }
  
  // Build tags row
  html += `<div>`;
  html += `<span class="tag ${status}">${status.toUpperCase()}</span>`;
  html += `<span class="tag">Stage: ${stage}</span>`;
  if(entity){
    html += `<span class="tag">Entity: ${entity}</span>`;
  }
  if(parsed.product_type){
    html += `<span class="tag">${parsed.product_type}</span>`;
  }
  html += `</div>`;
  
  // Build details section
  html += `<div style="margin-top:4px;font-size:12px;">`;
  if(parsed.variant_info){
    html += `Variant: ${parsed.variant_info}<br/>`;
  }
  if(parsed.order_id){
    html += `Order: ${parsed.order_id}<br/>`;
  }
  html += `Scanner: ${ids.scanner_id}, Station: ${ids.station_id}<br/>`;
  html += `Timestamp: ${timestamp}`;
  html += `</div>`;

  lastScanContent.innerHTML = html;

  if(status==="new" && navigator.vibrate) navigator.vibrate(60);
  
  // Show red warning for duplicate scans
  if(isDuplicate){
    showDuplicateWarning();
    if(navigator.vibrate) navigator.vibrate([100, 50, 100]); // Double vibration for duplicate
    scanLog.textContent = "⚠ DUPLICATE SCAN - Updated existing record.";
  } else {
    scanLog.textContent = "✓ Saved new scan.";
  }
}

/* ===========
   CLEAR + EXPORT
   =========== */
btnClear.onclick = ()=>{
  if(!confirm("Clear all scans?")) return;
  localStorage.removeItem(STORE_KEY);
  renderHistory();
  lastScanContent.innerHTML="No scan yet.";
  scanLog.textContent="All scans cleared.";
};

btnExport.onclick = ()=>{
  const db=loadStore();
  const rows=Object.keys(db);
  if(!rows.length){ scanLog.textContent="Nothing to export."; return; }

  const header=[
    "uid","stage","entity","scanner_id","station_id","timestamp"
  ];
  const dataRows = rows.map(uid=>{
    const r=db[uid];
    // Handle backwards compatibility - older records may not have all fields
    return header.map(k=>{
      if(k==="uid") return uid;
      return r[k] || "";
    });
  });

  const csv = [
    header.join(","),
    ...dataRows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(","))
  ].join("\n");

  const blob = new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="qr_scans.csv";
  a.click();
};

// Verify button handlers are attached
console.log("App initialized. Button handlers attached:", {
  btnStart: !!btnStart.onclick,
  btnStop: !!btnStop.onclick,
  library: !!window.Html5Qrcode
});

} // end initializeApp
</script>

</body>
</html>
