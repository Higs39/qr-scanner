<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Production QR Station</title>
  <style>
    body { font-family: system-ui, sans-serif; margin:0; background:#f4f6f8; }
    .page { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .top-bar {
      display:flex; flex-wrap:wrap; gap:8px;
      justify-content:space-between; align-items:center;
      margin-bottom:12px;
    }
    .pill {
      padding:6px 10px; border-radius:999px;
      background:#e1e5ec; font-size:13px;
    }
    .pill strong { font-weight:600; }
    .controls-row { display:flex; flex-wrap:wrap; gap:8px; margin: 8px 0 12px; }
    button, select {
      padding:8px 10px; border-radius:6px;
      border:1px solid #c0c6d0; background:white;
      font-size:14px; cursor:pointer;
    }
    button.primary { background:#2257d8; color:white; border-color:#2257d8; }
    button.small { padding:4px 8px; font-size:12px; }
    #reader { width:100%; max-width:520px; margin: 0 auto 12px; background:#000; }
    .panel {
      background:white; border-radius:10px; padding:12px;
      margin-bottom:12px; box-shadow:0 2px 4px rgba(0,0,0,0.05);
    }
    .panel h3 { margin:0 0 8px; font-size:16px; }
    .field-row {
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:center; margin-bottom:8px; font-size:14px;
    }
    .field-row label { font-size:13px; color:#444; }
    .tag {
      display:inline-block; padding:3px 7px;
      border-radius:999px; font-size:11px;
      background:#eef1f7; margin-right:6px;
    }
    .tag.new { background:#e0ffe5; }
    .tag.update { background:#ffeccc; }
    .log-area {
      white-space:pre-wrap; font-size:12px;
      background:#f1f3f7; padding:6px 8px;
      border-radius:6px; margin-top:4px;
    }
    table {
      border-collapse:collapse; width:100%; font-size:12px;
    }
    th, td { border:1px solid #d2d5dd; padding:4px 6px; }
    th { background:#eef1f7; text-align:left; font-weight:600; }

    /* modal */
    .modal-backdrop {
      position:fixed; inset:0; background:rgba(0,0,0,0.5);
      display:none; align-items:center; justify-content:center; z-index:9999;
    }
    .modal {
      background:#fff; width:min(92vw, 380px);
      border-radius:10px; padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,0.25);
    }
    .modal input {
      width:100%; padding:7px 8px;
      border-radius:6px; border:1px solid #c0c6d0;
    }
  </style>
</head>
<body>
<div class="page">

  <div class="top-bar">
    <div style="display:flex;flex-wrap:wrap;gap:6px;">
      <div class="pill">Scanner: <strong id="scannerDisplay">unset</strong></div>
      <div class="pill">Station: <strong id="stationDisplay">unset</strong></div>
    </div>
    <div class="controls-row" style="margin:0;">
      <button id="btnChangeIds" class="small">Change IDs</button>
      <button id="btnExportCsv" class="small">Export CSV</button>
      <button id="btnClearScans" class="small">Clear scans</button>
    </div>
  </div>

  <!-- SCANNER PANEL -->
  <div class="panel">
    <div class="controls-row">
      <button id="btnStart" class="primary" disabled>Start camera</button>
      <button id="btnStop" disabled>Stop camera</button>
    </div>
    <div id="reader"></div>
    <div id="scanLog" class="log-area">Loading QR libraryâ€¦</div>
  </div>

  <!-- CONTEXT PANEL -->
  <div class="panel">
    <h3>Context</h3>
    <div class="field-row">
      <label>Stage:</label>
      <select id="stageSelect">
        <option value="receiving">Receiving</option>
        <option value="cutting">Cutting</option>
        <option value="edging">Edging</option>
        <option value="packing">Packing</option>
        <option value="shipment">Shipment</option>
        <option value="install">Install</option>
      </select>

      <label>Entity:</label>
      <select id="entitySelect">
        <option value="cabinet">Cabinet</option>
        <option value="pallet">Pallet</option>
        <option value="room">Room</option>
        <option value="accessory">Accessory</option>
      </select>
    </div>
  </div>

  <!-- LAST SCAN -->
  <div class="panel">
    <h3>Last scan</h3>
    <div id="lastScanContent">No scan yet.</div>
  </div>

  <!-- HISTORY -->
  <div class="panel">
    <h3>History</h3>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>UID</th>
          <th>Stage</th>
          <th>Entity</th>
          <th>Scanner</th>
          <th>Station</th>
          <th>Timestamp</th>
        </tr>
      </thead>
      <tbody id="historyBody"></tbody>
    </table>
  </div>

</div>

<!-- DEVICE ID MODAL -->
<div id="deviceModalBackdrop" class="modal-backdrop">
  <div class="modal">
    <h3>Set device identity</h3>
    <p style="font-size:13px;margin:4px 0 10px;">Saved once & used for every scan.</p>

    <label>Scanner ID</label>
    <input id="deviceScannerInput" placeholder="PH-01">

    <label style="margin-top:10px;">Station ID</label>
    <input id="deviceStationInput" placeholder="ST-01">

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
      <button id="deviceModalCancel" class="small">Cancel</button>
      <button id="deviceModalSave" class="small primary">Save</button>
    </div>
  </div>
</div>

<script>
/* ===========
   LOAD QR LIB
   =========== */
const CDN_SOURCES = [
  "https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js",
  "https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"
];

function loadScript(src){
  return new Promise((resolve,reject)=>{
    const s=document.createElement("script");
    s.src=src; s.async=true;
    s.onload=()=>resolve(src);
    s.onerror=()=>reject();
    document.head.appendChild(s);
  });
}

(async()=> {
  for(const src of CDN_SOURCES){
    try{
      await loadScript(src);
      if(window.Html5Qrcode){
        document.getElementById("scanLog").textContent = "QR library loaded.";
        document.getElementById("btnStart").disabled = false;
        return;
      }
    }catch(e){}
  }
  document.getElementById("scanLog").textContent="Failed to load QR library.";
})();
</script>

<script>
/* ===========
   STORAGE HELPERS
   =========== */
const STORE_KEY = "qr_scans_simple";
const IDS_KEY   = "device_ids_simple";

function loadStore(){ return JSON.parse(localStorage.getItem(STORE_KEY)||"{}"); }
function saveStore(db){ localStorage.setItem(STORE_KEY, JSON.stringify(db)); }

function loadIds(){ return JSON.parse(localStorage.getItem(IDS_KEY)||"{}"); }
function saveIds(ids){ localStorage.setItem(IDS_KEY, JSON.stringify(ids)); }

/* ===========
   UI ELEMENTS
   =========== */
const btnStart    = document.getElementById("btnStart");
const btnStop     = document.getElementById("btnStop");
const btnClear    = document.getElementById("btnClearScans");
const btnExport   = document.getElementById("btnExportCsv");
const btnChangeIds= document.getElementById("btnChangeIds");
const scanLog     = document.getElementById("scanLog");

const stageSelect = document.getElementById("stageSelect");
const entitySelect= document.getElementById("entitySelect");

const lastScanContent = document.getElementById("lastScanContent");
const historyBody = document.getElementById("historyBody");

const scannerDisplay = document.getElementById("scannerDisplay");
const stationDisplay = document.getElementById("stationDisplay");

const modal = document.getElementById("deviceModalBackdrop");
const mScanner = document.getElementById("deviceScannerInput");
const mStation = document.getElementById("deviceStationInput");
const mCancel  = document.getElementById("deviceModalCancel");
const mSave    = document.getElementById("deviceModalSave");

/* ===========
   INIT IDs
   =========== */
function updateIdDisplay(){
  const ids = loadIds();
  scannerDisplay.textContent = ids.scanner_id || "unset";
  stationDisplay.textContent = ids.station_id || "unset";
}
updateIdDisplay();

/* ===========
   SHOW / HIDE MODAL
   =========== */
function openModal(){
  const ids = loadIds();
  mScanner.value = ids.scanner_id || "";
  mStation.value = ids.station_id || "";
  modal.style.display="flex";
}
function closeModal(){
  modal.style.display="none";
}

btnChangeIds.onclick = openModal;
mCancel.onclick = closeModal;

mSave.onclick = () => {
  const scanner_id = mScanner.value.trim();
  const station_id = mStation.value.trim();
  if(!scanner_id || !station_id){
    alert("Both values required.");
    return;
  }
  saveIds({scanner_id, station_id});
  updateIdDisplay();
  closeModal();
};

/* ===========
   HISTORY RENDER
   =========== */
function renderHistory(){
  const db = loadStore();
  const rows = Object.keys(db).sort();
  historyBody.innerHTML = "";

  rows.forEach((uid,i)=>{
    const r = db[uid];
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${uid}</td>
      <td>${r.stage}</td>
      <td>${r.entity}</td>
      <td>${r.scanner_id}</td>
      <td>${r.station_id}</td>
      <td>${r.timestamp}</td>
    `;
    historyBody.appendChild(tr);
  });
}
renderHistory();

/* ===========
   QR SCANNER
   =========== */
let qr = null;
let running = false;
let debounceUntil = 0;
let pendingPayload = null;

btnStart.onclick = async () => {
  try{
    if(!window.Html5Qrcode){ scanLog.textContent="Library missing."; return; }
    if(running) return;

    scanLog.textContent="Requesting camera permission...";
    qr = new Html5Qrcode("reader");
    
    // Request camera permission first by trying to get cameras
    let cams = [];
    try {
      cams = await Html5Qrcode.getCameras();
    } catch(e) {
      // If getCameras fails, try requesting permission directly
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        stream.getTracks().forEach(track => track.stop());
        cams = await Html5Qrcode.getCameras();
      } catch(permError) {
        scanLog.textContent="Camera permission denied. Please allow camera access.";
        return;
      }
    }
    
    if(!cams.length){ scanLog.textContent="No camera found."; return; }

    const cam = cams.find(c=>/back|rear/i.test(c.label)) || cams[0];
    scanLog.textContent="Starting camera...";

    await qr.start(
      cam.id, 
      {
        fps: 15, 
        qrbox: {width: 320, height: 320},
        videoConstraints: {
          facingMode: cam.label.match(/back|rear/i) ? "environment" : "user"
        }
      }, 
      onDecoded,
      () => {} // verbose callback (optional)
    );
    running = true;
    btnStart.disabled=true;
    btnStop.disabled=false;
    scanLog.textContent="Camera started.";
  }catch(e){
    scanLog.textContent="Camera error: " + (e.message || e);
    console.error("Camera error:", e);
  }
};

btnStop.onclick = async () => {
  if(!running) return;
  try{ await qr.stop(); await qr.clear(); }catch(e){}
  running=false;
  btnStart.disabled=false;
  btnStop.disabled=true;
  scanLog.textContent="Camera stopped.";
};

function onDecoded(text){
  const now=Date.now();
  if(now<debounceUntil) return;
  debounceUntil = now + 1200;

  const payload = text.trim();
  const ids = loadIds();

  if(!ids.scanner_id || !ids.station_id){
    pendingPayload = payload;
    openModal();
    return;
  }

  processScan(payload);
}

function processScan(payload){
  const ids = loadIds();
  const db = loadStore();

  const timestamp = new Date().toISOString();
  const stage = stageSelect.value;
  const entity= entitySelect.value;

  let status = "update";
  if(!db[payload]){
    status = "new";
  }

  db[payload] = {
    scanner_id: ids.scanner_id,
    station_id: ids.station_id,
    stage,
    entity,
    timestamp
  };

  saveStore(db);
  renderHistory();

  lastScanContent.innerHTML = `
    <div><strong>UID:</strong> ${payload}</div>
    <div>
      <span class="tag ${status}">${status.toUpperCase()}</span>
      <span class="tag">Stage: ${stage}</span>
      <span class="tag">Entity: ${entity}</span>
    </div>
    <div style="margin-top:4px;font-size:12px;">
      Scanner: ${ids.scanner_id}, Station: ${ids.station_id}<br/>
      Timestamp: ${timestamp}
    </div>
  `;

  if(status==="new" && navigator.vibrate) navigator.vibrate(60);

  scanLog.textContent = status==="new" ? "Saved new scan." : "Updated scan.";
}

/* ===========
   CLEAR + EXPORT
   =========== */
btnClear.onclick = ()=>{
  if(!confirm("Clear all scans?")) return;
  localStorage.removeItem(STORE_KEY);
  renderHistory();
  lastScanContent.innerHTML="No scan yet.";
  scanLog.textContent="All scans cleared.";
};

btnExport.onclick = ()=>{
  const db=loadStore();
  const rows=Object.keys(db);
  if(!rows.length){ scanLog.textContent="Nothing to export."; return; }

  const header=[
    "uid","stage","entity","scanner_id","station_id","timestamp"
  ];
  const dataRows = rows.map(uid=>{
    const r=db[uid];
    return header.map(k=>k==="uid"?uid:r[k]||"");
  });

  const csv = [
    header.join(","),
    ...dataRows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(","))
  ].join("\n");

  const blob = new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="qr_scans.csv";
  a.click();
};
</script>

</body>
</html>
