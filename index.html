<!doctype html>
<html>
<head>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QR Scanner</title>
  <style>
    body { font-family: system-ui, sans-serif; margin:16px; }
    #reader { width:100%; max-width:520px; margin:12px auto; }
    button { padding:8px 12px; margin:6px 4px; }
    #log { white-space:pre-wrap; background:#f5f5f5; padding:8px; }
    table { border-collapse:collapse; width:100%; margin-top:12px; }
    th,td { border:1px solid #ddd; padding:6px; font-size:14px; }
    th { background:#f6f6f6; }
  </style>
</head>
<body>
  <h2>Simple QR Scanner</h2>

  <div>
    <button id="start">Start camera</button>
    <button id="stop" disabled>Stop camera</button>
    <button id="clear">Clear saved scans</button>
  </div>

  <div id="reader"></div>

  <h3>Last scan</h3>
  <div id="last">â€”</div>

  <h3>Saved scans</h3>
  <table id="tbl">
    <thead>
      <tr><th>#</th><th>Payload</th><th>First seen</th><th>Last seen</th><th>Count</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="log"></div>

  <!-- Load the QR library FIRST -->
  <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>

  <!-- Your logic AFTER the library -->
  <script>
    const STORE_KEY = "qr_scans_v1";

    function loadStore() {
      try { return JSON.parse(localStorage.getItem(STORE_KEY) || "{}"); }
      catch { return {}; }
    }
    function saveStore(obj) {
      localStorage.setItem(STORE_KEY, JSON.stringify(obj));
    }

    const startBtn = document.getElementById("start");
    const stopBtn  = document.getElementById("stop");
    const clearBtn = document.getElementById("clear");
    const lastDiv  = document.getElementById("last");
    const logDiv   = document.getElementById("log");
    const tbody    = document.querySelector("#tbl tbody");

    function log(msg){ logDiv.textContent = msg; }

    function render() {
      const db = loadStore();
      const rows = Object.keys(db).sort();
      tbody.innerHTML = "";
      rows.forEach((k,i)=>{
        const r = db[k];
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${i+1}</td>
                        <td style="word-break:break-all">${k}</td>
                        <td>${r.first_seen}</td>
                        <td>${r.last_seen}</td>
                        <td>${r.count}</td>`;
        tbody.appendChild(tr);
      });
    }
    render();

    let qr = null;
    let running = false;
    let debounceUntil = 0;

    startBtn.onclick = async () => {
      try {
        if (running) return;
        qr = new Html5Qrcode("reader");
        const cams = await Html5Qrcode.getCameras();
        if (!cams.length) { log("No camera found."); return; }
        const back = cams.find(c=>/back|rear|environment/i.test(c.label)) || cams[0];
        await qr.start(back.id, { fps:15, qrbox:320 }, onDecoded, _=>{});
        running = true;
        startBtn.disabled = true;
        stopBtn.disabled  = false;
        log("Camera started. Show a QR in the box.");
      } catch(e) {
        log("Camera start error: " + e);
      }
    };

    stopBtn.onclick = async () => {
      if (!running) return;
      try { await qr.stop(); await qr.clear(); }
      catch(e){ /* ignore */ }
      running = false;
      startBtn.disabled = false;
      stopBtn.disabled  = true;
      log("Camera stopped.");
    };

    function onDecoded(text) {
      const now = Date.now();
      if (now < debounceUntil) return;
      debounceUntil = now + 1200;

      const payload = text.trim();
      lastDiv.textContent = payload;

      const db = loadStore();
      const nowISO = new Date().toISOString();

      if (db[payload]) {
        db[payload].last_seen = nowISO;
        db[payload].count = (db[payload].count || 1) + 1;
        saveStore(db);
        render();
        alert(`Seen before\n\n${payload}\nFirst: ${db[payload].first_seen}\nLast: ${db[payload].last_seen}\nCount: ${db[payload].count}`);
      } else {
        db[payload] = { first_seen: nowISO, last_seen: nowISO, count: 1 };
        saveStore(db);
        render();
        if (navigator.vibrate) navigator.vibrate(60);
        log("Saved new QR payload.");
      }
    }

    clearBtn.onclick = () => {
      if (!confirm("Clear all saved scans on this device?")) return;
      localStorage.removeItem(STORE_KEY);
      render();
      log("All saved scans cleared.");
    };
  </script>
</body>
</html>
