<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Production QR Station</title>
  <style>
    :root {
      font-family: system-ui, sans-serif;
      color-scheme: light dark;
    }
    body { margin:0; padding:0; background:#f4f6f8; }
    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }
    .top-bar {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
    }
    .pill {
      padding:6px 10px;
      border-radius:999px;
      background:#e1e5ec;
      font-size:13px;
    }
    .pill strong { font-weight:600; }
    .controls-row {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin: 8px 0 12px;
    }
    button, select {
      padding:8px 10px;
      border-radius:6px;
      border:1px solid #c0c6d0;
      background:white;
      font-size:14px;
    }
    button.primary {
      background:#2257d8;
      color:white;
      border-color:#2257d8;
    }
    button.danger {
      background:#d9223a;
      color:white;
      border-color:#d9223a;
    }
    button.small {
      padding:4px 8px;
      font-size:12px;
    }
    #reader {
      width:100%;
      max-width:520px;
      margin: 0 auto 12px;
      background:#000;
    }
    .panel {
      background:white;
      border-radius:10px;
      padding:12px;
      margin-bottom:12px;
      box-shadow:0 2px 4px rgba(0,0,0,0.05);
    }
    .panel h3 {
      margin:0 0 8px;
      font-size:16px;
    }
    .field-row {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin-bottom:6px;
      font-size:14px;
    }
    .field-row label {
      font-size:13px;
      color:#444;
    }
    .field-row select, .field-row input {
      padding:6px 8px;
      border-radius:6px;
      border:1px solid #c0c6d0;
      font-size:13px;
    }
    .tag {
      display:inline-block;
      padding:3px 7px;
      border-radius:999px;
      font-size:11px;
      background:#eef1f7;
      margin-right:6px;
    }
    .tag.dup { background:#ffe0e0; }
    .tag.new { background:#e0ffe5; }
    .log-area {
      white-space:pre-wrap;
      font-size:12px;
      background:#f1f3f7;
      padding:6px 8px;
      border-radius:6px;
      margin-top:4px;
    }
    table {
      border-collapse:collapse;
      width:100%;
      font-size:12px;
    }
    th, td {
      border:1px solid #d2d5dd;
      padding:4px 6px;
    }
    th {
      background:#eef1f7;
      text-align:left;
      font-weight:600;
    }
    .tabs {
      display:flex;
      gap:6px;
      margin-bottom:6px;
    }
    .tabs button {
      padding:4px 10px;
      font-size:12px;
    }
    .tabs button.active {
      background:#2257d8;
      color:white;
      border-color:#2257d8;
    }
  </style>
</head>
<body>
<div class="page">

  <!-- Top bar: device identity + role -->
  <div class="top-bar">
    <div style="display:flex;flex-wrap:wrap;gap:6px;">
      <div class="pill">Scanner: <strong id="scannerDisplay">unset</strong></div>
      <div class="pill">Station: <strong id="stationDisplay">unset</strong></div>
      <div class="pill">Role: 
        <strong id="roleDisplay">operator</strong>
      </div>
    </div>
    <div class="controls-row" style="margin:0;">
      <button id="btnChangeIds" class="small">Change IDs</button>
      <button id="btnRoleOp"   class="small">Operator</button>
      <button id="btnRoleMgr"  class="small">Manager</button>
      <button id="btnRoleInst" class="small">Installer</button>
    </div>
  </div>

  <!-- Scanner controls + preview -->
  <div class="panel">
    <div class="controls-row">
      <button id="btnStart" class="primary">Start camera</button>
      <button id="btnStop" disabled>Stop camera</button>
      <button id="btnClearScans">Clear local scans</button>
      <button id="btnExportCsv">Export CSV</button>
    </div>
    <div id="reader"></div>
    <div id="scanLog" class="log-area">Camera not started.</div>
  </div>

  <!-- Context: stage, entity, pallet, room -->
  <div class="panel" id="contextPanel">
    <h3>Context</h3>
    <div class="field-row">
      <label>Stage:</label>
      <select id="stageSelect">
        <option value="receiving">Receiving</option>
        <option value="cutting">Cutting</option>
        <option value="edging">Edging</option>
        <option value="packing">Packing</option>
        <option value="shipment">Shipment</option>
        <option value="install">Install</option>
      </select>

      <label>Entity:</label>
      <select id="entitySelect">
        <option value="cabinet">Cabinet</option>
        <option value="pallet">Pallet</option>
        <option value="room">Room</option>
        <option value="accessory">Accessory</option>
      </select>
    </div>

    <div class="field-row">
      <label>Current pallet ID:</label>
      <input id="palletInput" placeholder="scan / type pallet UID" />
      <button id="btnSetPallet" class="small">Set pallet</button>
      <span class="tag" id="palletStatus">none</span>
    </div>

    <div class="field-row">
      <label>Current room ID:</label>
      <input id="roomInput" placeholder="scan / type room UID" />
      <button id="btnSetRoom" class="small">Set room</button>
      <span class="tag" id="roomStatus">none</span>
    </div>
  </div>

  <!-- Last scan card -->
  <div class="panel" id="lastScanPanel">
    <h3>Last scan</h3>
    <div id="lastScanContent">
      <div>No scan yet.</div>
    </div>
    <div class="controls-row">
      <button id="btnAssignToPallet" class="small">Assign to pallet</button>
      <button id="btnAssignToRoom"   class="small">Assign to room</button>
      <button id="btnRebind"         class="small">Rebind UID</button>
    </div>
  </div>

  <!-- History + filters -->
  <div class="panel">
    <h3>History</h3>

    <div class="tabs">
      <button id="tabAll"      class="active small">All</button>
      <button id="tabPallet"   class="small">By pallet</button>
      <button id="tabRoom"     class="small">By room</button>
      <button id="tabDuplicates" class="small">Duplicates</button>
    </div>

    <div class="field-row">
      <label>Filter by stage:</label>
      <select id="filterStage">
        <option value="">Any</option>
        <option value="receiving">Receiving</option>
        <option value="cutting">Cutting</option>
        <option value="edging">Edging</option>
        <option value="packing">Packing</option>
        <option value="shipment">Shipment</option>
        <option value="install">Install</option>
      </select>

      <label>Filter by entity:</label>
      <select id="filterEntity">
        <option value="">Any</option>
        <option value="cabinet">Cabinet</option>
        <option value="pallet">Pallet</option>
        <option value="room">Room</option>
        <option value="accessory">Accessory</option>
      </select>
    </div>

    <table id="historyTable">
      <thead>
        <tr>
          <th>#</th>
          <th>UID</th>
          <th>Stage</th>
          <th>Entity</th>
          <th>Pallet</th>
          <th>Room</th>
          <th>Scanner</th>
          <th>Station</th>
          <th>First seen</th>
          <th>Last seen</th>
          <th>Count</th>
        </tr>
      </thead>
      <tbody id="historyBody"></tbody>
    </table>
  </div>

</div>

<!-- Device ID modal structure (reuse your existing logic, just structure here) -->
<div id="deviceModalBackdrop" style="
  position:fixed;inset:0;background:rgba(0,0,0,0.5);
  display:none;align-items:center;justify-content:center;z-index:9999;">
  <div style="background:#fff;width:min(92vw,420px);border-radius:10px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,0.25);">
    <h3 style="margin-top:0;">Set device identity</h3>
    <div style="margin-bottom:8px;font-size:13px;">Saved once per device. Used for every scan.</div>
    <div style="margin-bottom:8px;">
      <label style="font-size:13px;">Scanner ID</label>
      <input id="deviceScannerInput" style="width:100%;padding:8px;border-radius:6px;border:1px solid #c0c6d0;" placeholder="e.g. PH-01" />
    </div>
    <div style="margin-bottom:8px;">
      <label style="font-size:13px;">Station ID</label>
      <input id="deviceStationInput" style="width:100%;padding:8px;border-radius:6px;border:1px solid #c0c6d0;" placeholder="e.g. ST-01" />
    </div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px;">
      <button id="deviceModalCancel" class="small">Cancel</button>
      <button id="deviceModalSave" class="small primary">Save</button>
    </div>
  </div>
</div>

<!-- Scripts go here: first load html5-qrcode, then your logic -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
<script>
  // Here you plug in the logic you already built:
  // - load/save device IDs (scanner/station) to localStorage
  // - start/stop camera using Html5Qrcode on btnStart/btnStop
  // - on every decode:
  //    * read current stage/entity
  //    * attach pallet/room ids
  //    * write records into a local "DB" and repaint history table
  //    * update lastScanPanel: UID + tags (new/duplicate, stage, entity)
  //    * for duplicates, highlight with .tag.dup
  // - wire Export CSV and Clear to your existing functions

  // Minimal placeholders so page doesnâ€™t error:
  document.getElementById("btnChangeIds").onclick = () => {
    document.getElementById("deviceModalBackdrop").style.display = "flex";
  };
  document.getElementById("deviceModalCancel").onclick = () => {
    document.getElementById("deviceModalBackdrop").style.display = "none";
  };
  document.getElementById("deviceModalSave").onclick = () => {
    // Save scanner/station here and update #scannerDisplay / #stationDisplay
    document.getElementById("deviceModalBackdrop").style.display = "none";
  };
</script>
</body>
</html>
